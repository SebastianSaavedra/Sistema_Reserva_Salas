<!-- info_sala_individual.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Información de Sala</title>
</head>
<body>
    <h1>Información de Sala</h1>
    <ul>
        <li>Numero: {{ sala_data.numero }}</li>
        <li>Capacidad: {{ sala_data.capacidad }}</li>
        <!-- Agregar más campos según sea necesario -->
    </ul>

    <h2>Reservar Sala</h2>
    <form id="reservaForm" onsubmit="hacerReserva(event)">
        <label for="fechaInicio">Fecha de inicio:</label>
        <input type="text" id="fechaInicio" name="fechaInicio" required>
        
        <label for="fechaFin">Fecha de fin:</label>
        <input type="text" id="fechaFin" name="fechaFin" required>

        <label for="nombreReservante">Nombre del reservante:</label>
        <input type="text" id="nombreReservante" name="nombreReservante" required>
        
        <button type="submit">{{ sala_data.enlaces[2].rel }}</button>
    </form> 

    <!-- Agregar después del formulario -->
    <div id="horariosDisponibles"></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
    function getCookieValue(cookieName) {
        const cookies = document.cookie.split(';');
        for (const cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === cookieName) {
                return value;
            }
        }
        return null;  // Si no se encuentra la cookie
        }

        // Permite creaar el calendario y horario mas modular
        flatpickr("#fechaInicio", {
            altInput: true,
                altFormat: "F j, Y H:i",
                enableTime: true,
                time_24hr: true,
                noCalendar: false,
                minDate: "today",
                minTime: "08:00",
                maxTime: "22:30",
                dateFormat: "Y-m-d H:i",
                minuteIncrement: 60
        });

        flatpickr("#fechaFin", {
            altInput: true,
                altFormat: "F j, Y H:i",
                enableTime: true,
                time_24hr: true,
                noCalendar: false,
                minDate: "today",
                minTime: "08:00",
                maxTime: "22:30",
                dateFormat: "Y-m-d H:i",
                minuteIncrement: 60
        });

        // Obtener el elemento donde se mostraran los horarios disponibles
        const horariosDisponiblesElement = document.getElementById("horariosDisponibles");

        // Manejar cambios en las fechas
        document.getElementById("fechaInicio").addEventListener("change", actualizarHorariosDisponibles);
        document.getElementById("fechaFin").addEventListener("change", actualizarHorariosDisponibles);

        // Función para actualizar los horarios disponibles
        async function actualizarHorariosDisponibles() {
            const fechaInicio = document.getElementById("fechaInicio").value;
            const fechaFin = document.getElementById("fechaFin").value;

            // Verificar si las fechas están presentes
            if (!fechaInicio || !fechaFin) {
                return;
            }

            try {
                // Realizar la solicitud al backend para obtener los horarios disponibles
                const url = new URL(`/{{ oficina_id }}/horarios_disponibles`, window.location.origin);
                url.searchParams.append('fechaInicio', fechaInicio);
                url.searchParams.append('fechaFin', fechaFin);
                url.searchParams.append('sala_id', '{{sala_id}}');

                const response = await fetch(url);
                const horariosDisponibles = await response.json();

                // Mostrar los horarios disponibles en la página
                horariosDisponiblesElement.innerText = JSON.stringify("Horarios disponibles: " + horariosDisponibles);
            } catch (error) {
                console.error('Error al obtener horarios disponibles:', error);
                // Manejar errores, por ejemplo, mostrar un mensaje de error
                horariosDisponiblesElement.innerText = ('Error al obtener horarios disponibles:', error);
            }
        }


        function hacerReserva(event) {
            event.preventDefault();  // Evita que el formulario se envíe automáticamente

            // Obtener datos del formulario
            const fechaInicio = document.getElementById("fechaInicio").value;
            const fechaFin = document.getElementById("fechaFin").value;
            const nombreReservante = document.getElementById("nombreReservante").value;
            const oficina_id = getCookieValue('oficina_id');

            // Verificar si introdujo fechas
            if (!fechaInicio || !fechaFin || fechaFin <= fechaInicio) {
                alert('Por favor, rellena los campos con fechas validas.');
                return;
            }

            // Realizar la solicitud de reserva al backend
            // Puedes usar fetch o axios para realizar una solicitud POST al endpoint de reserva

            // Ejemplo usando fetch:   
            fetch(`/{{ oficina_id }}/reservar/{{ sala_id }}`, {
                method: 'POST',
                redirect: 'follow',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    sala_id: '{{sala_id}}',
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin,
                    nombre_reservante: nombreReservante,
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error al hacer la reserva: ${response.statusText}`);
                }
                if (response.redirected) {
                    alert('Reserva Exitosa!');
                    window.location.href = response.url;  // or, location.replace(res.url); 
                    return;
                } 
                else
                    return response.json();
            })
            .catch(error => {
                console.error('Error al hacer la reserva:', error);
                // Manejar errores, por ejemplo, mostrar un mensaje de error
                alert('Error al hacer la reserva. Por favor, inténtelo de nuevo.');
            });
        }
    </script>
</body>
</html>
